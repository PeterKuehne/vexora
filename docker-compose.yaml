# Vexora RAG Infrastructure
# Start with: docker compose up -d
# Stop with: docker compose down
# Reset data: docker compose down -v

services:
  # Vector Database for hybrid search (semantic + keyword)
  weaviate:
    image: cr.weaviate.io/semitechnologies/weaviate:1.28.4
    container_name: vexora-weaviate
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "50051:50051"  # gRPC port
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
      PERSISTENCE_DATA_PATH: "/var/lib/weaviate"
      DEFAULT_VECTORIZER_MODULE: "none"
      ENABLE_MODULES: ""
      CLUSTER_HOSTNAME: "node1"
      LOG_LEVEL: "info"
    volumes:
      - weaviate_data:/var/lib/weaviate
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/v1/.well-known/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G

  # PostgreSQL with pgvector extension for structured data
  postgresql:
    image: pgvector/pgvector:pg16
    container_name: vexora-postgresql
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: vexora
      POSTGRES_PASSWORD: vexora_dev_password
      POSTGRES_DB: vexora
    volumes:
      - postgresql_data:/var/lib/postgresql/data
      - ./docker/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vexora -d vexora"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G

  # Redis for caching and background job processing
  redis:
    image: redis:7-alpine
    container_name: vexora-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M

volumes:
  weaviate_data:
    name: vexora_weaviate_data
  postgresql_data:
    name: vexora_postgresql_data
  redis_data:
    name: vexora_redis_data

networks:
  default:
    name: vexora_network
