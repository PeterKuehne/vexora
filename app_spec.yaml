project_context:
  name: "Vexora Enterprise Authentication & Authorization System"
  type: "enhancement"
  current_stack:
    frontend: "React 19 + TypeScript + Vite"
    backend: "Express.js + TypeScript"
    llm: "Ollama (local)"
    vector_db: "Weaviate"
    database: "PostgreSQL"
    styling: "Tailwind CSS"
  scale: "100+ gleichzeitige Benutzer, 1000+ Dokumente"
  deployment: "Self-hosted Enterprise"

existing_functionality:
  - "Single-User RAG-System ohne Authentifizierung"
  - "Dokument-Upload und -Verarbeitung"
  - "RAG-basierte Chat-Funktion mit Ollama"
  - "Weaviate Vektor-Suche"
  - "PostgreSQL Dokumenten-Speicherung"
  - "Real-time Streaming Responses"
  - "Multiple Conversation Management"
  - "Markdown Rendering mit Code Syntax Highlighting"

requirements:
  - name: "SSO Authentication"
    priority: high

    libraries:
      - "arctic"
      - "@azure/msal-node"
      - "jsonwebtoken"
      - "bcrypt"
      - "express-session"

    implementation_scope:
      - "OAuth2 Authorization Code Flow mit PKCE"
      - "Microsoft Entra ID Integration"
      - "Google Workspace Integration"
      - "JWT-Token Generation und Validierung"
      - "Refresh-Token Flow"
      - "Automatische Profil-Erstellung beim ersten Login"

    constraints:
      - "Login < 5 Sekunden"
      - "JWT signiert mit min 256 Bit Secret"
      - "HTTPS fuer OAuth2-Callbacks in Produktion"
      - "Access-Token 15min, Refresh-Token 30 Tage"

    success_criteria:
      - "Login mit Microsoft/Google funktioniert"
      - "Session 7 Tage gueltig mit Refresh-Token"
      - "Logout invalidiert Token"

    out_of_scope:
      - "SAML SSO"
      - "2FA/MFA"
      - "Passwort-Reset"

  - name: "Benutzerverwaltung"
    priority: high

    libraries: []

    implementation_scope:
      - "Admin-UI fuer Benutzer anzeigen, Rollen zuweisen, Abteilungen zuordnen"
      - "Benutzer deaktivieren und Profile bearbeiten"
      - "Benutzer-Profil ansehen/bearbeiten (Self-Service)"
      - "PostgreSQL users-Tabelle (id, email, name, role, department, provider)"
      - "Audit-Trail fuer Benutzeraenderungen"

    constraints:
      - "Nur Admins verwalten Benutzer"
      - "Mindestens ein Admin muss existieren"
      - "Email eindeutig"

    success_criteria:
      - "Admin kann Rollen/Abteilungen zuweisen"
      - "Deaktivierte Benutzer koennen sich nicht anmelden"

    out_of_scope:
      - "Gruppen/Teams"
      - "Einladungen"
      - "Self-Service-Registrierung"

  - name: "Rollenbasierte Zugriffskontrolle (RBAC)"
    priority: high

    libraries: []

    implementation_scope:
      - "Drei Rollen: Employee, Manager, Admin"
      - "Employee: Eigene Dokumente"
      - "Manager: Abteilungs-Dokumente"
      - "Admin: Alle Dokumente + System-Einstellungen"
      - "Rollen definieren API-Zugriff und UI-Sichtbarkeit"

    constraints:
      - "Ein Benutzer = eine Rolle"
      - "Rollenwechsel nur durch Admin"

    success_criteria:
      - "Employee sieht nur eigene Dokumente"
      - "Manager sieht Abteilungs-Dokumente"
      - "Admin sieht alles"

    out_of_scope:
      - "Custom Roles"
      - "Rollen-Hierarchien"
      - "Mehrere Rollen pro Benutzer"

  - name: "Dokument-Berechtigungen"
    priority: high

    libraries: []

    implementation_scope:
      - "Dokument-Attribute: Owner, Department, Classification, Allowed Roles, Allowed Users"
      - "Klassifikationsstufen: public, internal, confidential, restricted"
      - "Berechtigungen beim Upload festlegbar"
      - "Nachtraegliche Aenderung durch Owner/Admin"

    constraints:
      - "Employee max 'internal'"
      - "Manager max 'confidential'"
      - "Aenderungen sofort wirksam"

    success_criteria:
      - "Classification bestimmt Sichtbarkeit"
      - "RAG-Suche respektiert Berechtigungen automatisch"

    out_of_scope:
      - "Zeitlich begrenzte Berechtigungen"
      - "Externe Freigabe-Links"

  - name: "PostgreSQL Row Level Security (RLS)"
    priority: high

    libraries: []

    implementation_scope:
      - "RLS auf documents-Tabelle aktivieren"
      - "Policies: public, department, owner, role, user, admin"
      - "Automatische Filterung transparent fuer Anwendungscode"
      - "Benutzerkontext via SET LOCAL (user_id, role, department)"

    constraints:
      - "Performance < 50ms"
      - "Policies vor jeder Query setzen"

    success_criteria:
      - "SELECT * FROM documents zeigt nur autorisierte Dokumente"
      - "Marketing sieht keine HR-Dokumente"

    out_of_scope:
      - "RLS auf anderen Tabellen"
      - "Dynamische Policy-Generierung"

  - name: "Secure RAG Service"
    priority: high

    libraries: []

    implementation_scope:
      - "VOR Vektor-Suche: Benutzerkontext ermitteln, RLS setzen, erlaubte document_ids abrufen"
      - "Weaviate Filter mit erlaubten document_ids erstellen"
      - "Filterung VOR Suche (nicht Post-Processing)"
      - "Verifizieren dass Chunks autorisiert sind"
      - "Nur sichtbare Source Citations anzeigen"
      - "Audit-Log fuer RAG-Queries"

    constraints:
      - "Performance +100ms max gegenueber ungefiltert"
      - "Zero Information Leakage"
      - "Anti-Pattern vermeiden: Post-Processing Filterung"

    success_criteria:
      - "Marketing fragt 'Gehaelter' -> Keine HR-Daten"
      - "Nur autorisierte Citations anzeigen"

    out_of_scope:
      - "Query-Rewriting zur Umgehung"
      - "Partial Results"

  - name: "API-Authentifizierung"
    priority: high

    libraries: []

    implementation_scope:
      - "JWT-Token in Authorization-Header erforderlich"
      - "Token-Validierung Middleware"
      - "401 Unauthorized bei fehlendem/ungueltigem Token"
      - "403 Forbidden bei fehlenden Berechtigungen"
      - "Geschuetzte Endpunkte: /api/rag/*, /api/chat/*, /api/ollama/*"

    constraints:
      - "Middleware < 10ms Overhead"
      - "Token-Refresh unterstuetzen"

    success_criteria:
      - "Ohne Token -> 401"
      - "Mit gueltigem Token -> Benutzer-Kontext verfuegbar"

    out_of_scope:
      - "API-Keys"
      - "Rate Limiting"
      - "IP-Restriktion"

  - name: "Frontend Login & Session"
    priority: high

    libraries:
      - "react-router-dom"
      - "axios"

    implementation_scope:
      - "Login-Seite mit Microsoft/Google SSO-Buttons (separate Route /login)"
      - "OAuth2 Redirect-Flow"
      - "JWT in localStorage oder httpOnly-Cookie"
      - "Auto-Refresh mit Refresh-Token"
      - "ProtectedRoute Komponente (schuetzt /chat und /documents Routen)"
      - "React Router Setup mit Routes: /login, /chat, /documents"
      - "Benutzer-Menu in Navbar (Profil, Logout)"

    constraints:
      - "Responsiv (Mobile + Desktop)"
      - "Token nicht in URL"

    success_criteria:
      - "SSO-Flow funktioniert (OAuth2 -> Redirect zu /chat)"
      - "Nicht-authentifizierte Benutzer werden zu /login redirected"
      - "ProtectedRoute schuetzt /chat und /documents Routen"
      - "Navbar zeigt Benutzernamen"
      - "Logout leitet zu /login um"

    out_of_scope:
      - "Profil-Bearbeitung"
      - "Passwort-Aenderung"
      - "Session-Historie"

  - name: "Audit Logging"
    priority: medium

    libraries: []

    implementation_scope:
      - "Protokollieren: Logins, Dokument-Uploads, RAG-Queries, Berechtigungsaenderungen, Admin-Aktionen"
      - "Log-Eintraege: Timestamp, User-ID, Email, Aktion, Ressource, Ergebnis"
      - "PostgreSQL audit_logs Tabelle"
      - "90 Tage Aufbewahrung"
      - "Admin-Zugriff auf Logs"
      - "Append-only (Manipulationsschutz)"

    constraints:
      - "Keine Performance-Einbussen"
      - "Keine sensiblen Daten in Logs"

    success_criteria:
      - "Admin sieht Upload/Query-Historie"
      - "Fehlgeschlagene Logins protokolliert"

    out_of_scope:
      - "Echtzeit-Alerting"
      - "SIEM-Integration"
      - "Log-Export"

  - name: "Upload mit Berechtigungen"
    priority: high

    libraries: []

    implementation_scope:
      - "Upload-UI mit Classification Dropdown"
      - "Sichtbarkeit: nur ich, Abteilung, alle"
      - "Multi-Select fuer spezifische Benutzer"
      - "Owner und Department automatisch setzen"
      - "Default-Classification basierend auf Rolle"
      - "Berechtigungen in PostgreSQL + Weaviate speichern"
      - "Vorschau effektiver Berechtigungen"

    constraints:
      - "Employee max 'internal'"
      - "Manager max 'confidential'"
      - "Nachtraegliche Aenderung moeglich (Owner/Admin)"

    success_criteria:
      - "Upload zeigt Berechtigungsoptionen"
      - "Berechtigungen korrekt gespeichert"

    out_of_scope:
      - "Bulk-Upload mit Berechtigungen"
      - "Template-Berechtigungen"

  - name: "Intelligent RAG Activation (Smart Auto)"
    priority: high

    libraries: []

    implementation_scope:
      - "RAG aktiviert sich automatisch bei relevanten Queries"
      - "Intent Detection (keyword-basiert)"
      - "Query analysieren ob firmenspezifisch"
      - "Source Citations anzeigen wenn RAG genutzt wurde"
      - "Settings: Immer an, Automatisch (default), Manueller Toggle"

    constraints:
      - "Intent Detection < 50ms"
      - "Kein RAG bei Smalltalk (Performance)"
      - "Transparenz: User muss wissen ob RAG aktiv war"

    success_criteria:
      - "'Was ist unsere Pricing-Strategie?' -> RAG laeuft automatisch"
      - "'Wie gehts?' -> Kein RAG"
      - "User sieht '3 Quellen gefunden' oder keine Anzeige"

    out_of_scope:
      - "Komplexe LLM-basierte Intent Detection"

  - name: "Document Management Page"
    priority: high

    libraries:
      - "socket.io-client"
      - "react-router-dom"

    implementation_scope:
      - "Dedizierte Route /documents mit React Router (separate Seite, NICHT Sidebar)"
      - "Vollbild-Seite fuer Dokumente (gesamter Viewport, kein Sidebar-Panel)"
      - "Header Navigation mit Links: Chat | Dokumente (Page-Wechsel via React Router)"
      - "Upload-Bereich mit Drag & Drop + Permission-Panel"
      - "Storage-Quota-Anzeige"
      - "Filter & Suche (Kategorie, Tags, Name)"
      - "Document-Table (sortierbar, filterbar, selectable)"
      - "Bulk-Actions (Multi-Select, Bulk-Delete)"
      - "Permission-Badges und Inline-Actions"
      - "Echtzeit-Updates via Socket.io"

    constraints:
      - "Responsiv (Mobile + Desktop)"
      - "1000+ Dokumente ohne Performance-Probleme"

    success_criteria:
      - "User kann zur separaten /documents Seite navigieren (nicht Sidebar)"
      - "Dokumente-Seite nutzt vollen Bildschirm"
      - "Navigation zwischen Chat und Documents funktioniert (React Router)"
      - "User findet Dokumente in < 3 Klicks"
      - "Table-Sorting/Filtering funktioniert"
      - "Permission-Badges zeigen Zugriff klar"
      - "Storage-Quota sichtbar"

    out_of_scope:
      - "Sidebar-basiertes Document Management (muss separate Seite sein)"
      - "Document-Preview"
      - "Annotations"
      - "Grid-View"

tech_stack:
  new_dependencies:
    npm:
      - "arctic@^3.7.0"
      - "@azure/msal-node@^3.8.5"
      - "jsonwebtoken@^9.0.3"
      - "bcrypt@^6.0.0"
      - "express-session@^1.18.2"
      - "react-router-dom@^7.12.0"
      - "axios"
      - "@types/jsonwebtoken@^9.0.7"
      - "@types/bcrypt@^5.0.2"
      - "@types/express-session@^1.18.0"
    pip: []

  apis_to_create:
    - endpoint: "GET /api/auth/microsoft"
      description: "Initiiere Microsoft OAuth2 Login"
      authentication: "none"

    - endpoint: "GET /api/auth/microsoft/callback"
      description: "Microsoft OAuth2 Callback Handler"
      authentication: "none"

    - endpoint: "GET /api/auth/google"
      description: "Initiiere Google OAuth2 Login"
      authentication: "none"

    - endpoint: "GET /api/auth/google/callback"
      description: "Google OAuth2 Callback Handler"
      authentication: "none"

    - endpoint: "POST /api/auth/logout"
      description: "Logout und Token invalidieren"
      authentication: "JWT required"

    - endpoint: "GET /api/auth/me"
      description: "Aktuellen Benutzer abrufen"
      authentication: "JWT required"

    - endpoint: "POST /api/auth/refresh"
      description: "Access-Token mit Refresh-Token erneuern"
      authentication: "Refresh-Token required"

    - endpoint: "GET /api/users"
      description: "Alle Benutzer auflisten"
      authentication: "JWT required, Admin only"

    - endpoint: "GET /api/users/:id"
      description: "Einzelnen Benutzer abrufen"
      authentication: "JWT required"

    - endpoint: "PUT /api/users/:id"
      description: "Benutzer aktualisieren"
      authentication: "JWT required, Admin only"

    - endpoint: "PUT /api/users/:id/role"
      description: "Benutzer-Rolle aendern"
      authentication: "JWT required, Admin only"

    - endpoint: "PUT /api/users/:id/deactivate"
      description: "Benutzer deaktivieren"
      authentication: "JWT required, Admin only"

    - endpoint: "GET /api/audit/logs"
      description: "Audit-Logs abrufen"
      authentication: "JWT required, Admin only"

    - endpoint: "GET /api/audit/logs/user/:id"
      description: "Audit-Logs fuer Benutzer"
      authentication: "JWT required, Admin only"

  database_changes:
    - "CREATE TABLE users (id, email UNIQUE, name, role, department, provider, provider_id, is_active, created_at, last_login)"
    - "CREATE TABLE refresh_tokens (id, user_id, token_hash, expires_at, created_at)"
    - "CREATE TABLE audit_logs (id, user_id, user_email, action, resource_type, resource_id, result, ip_address, user_agent, metadata JSONB, created_at)"
    - "ALTER TABLE documents ADD COLUMN owner_id, department, classification, allowed_roles[], allowed_users[]"
    - "CREATE INDEX users_email_idx ON users(email)"
    - "CREATE INDEX users_provider_idx ON users(provider, provider_id)"
    - "CREATE INDEX documents_owner_idx ON documents(owner_id)"
    - "CREATE INDEX documents_department_idx ON documents(department)"
    - "CREATE INDEX documents_classification_idx ON documents(classification)"
    - "CREATE INDEX audit_logs_user_created_idx ON audit_logs(user_id, created_at)"
    - "CREATE INDEX audit_logs_action_created_idx ON audit_logs(action, created_at)"
    - "ALTER TABLE documents ENABLE ROW LEVEL SECURITY"
    - "CREATE POLICY documents_public_policy ON documents"
    - "CREATE POLICY documents_department_policy ON documents"
    - "CREATE POLICY documents_owner_policy ON documents"
    - "CREATE POLICY documents_role_policy ON documents"
    - "CREATE POLICY documents_user_policy ON documents"
    - "CREATE POLICY documents_admin_policy ON documents"

security:
  principles:
    - "Zero-Trust Architecture: Authentifizierung + Autorisierung bei jedem Request"
    - "Defense in Depth: Frontend Guards + API Middleware + Service Layer + RLS"
    - "Authorization as Query Logic: Filterung VOR Suche"
  token_config:
    access_token_ttl: "15 minutes"
    refresh_token_ttl: "30 days"
    jwt_secret_min_bits: 256
  compliance:
    - "DSGVO-konform (Art. 15, 17)"
    - "IP-Anonymisierung nach 90 Tagen"
    - "Audit-Trail vollstaendig"

performance:
  targets:
    - "Login < 3 Sekunden"
    - "Token-Validierung < 5ms"
    - "RLS-Policy < 50ms"
    - "RAG-Authorization < 150ms"
    - "100+ gleichzeitige Benutzer"
    - "1 Million Audit-Log Eintraege"

migration_phases:
  - phase: 1
    name: "Authentication"
    duration: "Woche 1"
    scope:
      - "PostgreSQL: users, refresh_tokens"
      - "JWT-Service, Middleware"
      - "OAuth2 mit Arctic (Google, Microsoft)"
      - "Frontend: Login-Seite, Protected Routes"

  - phase: 2
    name: "Authorization"
    duration: "Woche 2"
    scope:
      - "PostgreSQL: documents erweitern"
      - "RLS Policies"
      - "Authorization-Service"

  - phase: 3
    name: "Secure RAG"
    duration: "Woche 3"
    scope:
      - "Secure RAG Service (Filterung VOR Suche)"
      - "Upload mit Berechtigungen"
      - "Berechtigungs-UI"

  - phase: 4
    name: "User Management"
    duration: "Woche 4"
    scope:
      - "Admin-UI"
      - "Rollen/Abteilungen zuweisen"

  - phase: 5
    name: "Audit & Compliance"
    duration: "Woche 5"
    scope:
      - "Audit-Logging"
      - "Audit-Log-UI"

  - phase: 6
    name: "Document Page & Smart RAG"
    duration: "Woche 6"
    scope:
      - "/documents Route"
      - "Document Table/Grid"
      - "Intelligent RAG Activation"

  - phase: 7
    name: "Testing & Hardening"
    duration: "Woche 7"
    scope:
      - "Security Testing"
      - "Performance Testing"
      - "Penetration Testing"

metadata:
  generated_at: "2026-01-22T10:30:00Z"
  generated_by: "adw-spec-analyze-agent"
  source_file: "specs/enterprise-auth-system.txt"
  template_version: "1.0.0"
